<!DOCTYPE html>
<html>
<head>
<link rel="shortcut icon" href="Orb_Icons_005.png" type="image/x-icon" />
<script src="http://www.kryogenix.org/code/browser/sorttable/sorttable.js" type="text/javascript"></script>
<link rel="stylesheet" href="http://jqueryui.com/jquery-wp-content/themes/jqueryui.com/style.css">
<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js"></script>
<script src="http://netgear.rohidekar.com/yurl/jquery/jquery-ui.js"></script>
<script src="http://netgear.rohidekar.com/yurl/js/imagezoom.ssarnobat.js"></script>
<script type="text/javascript" src="http://netgear.rohidekar.com/yurl/jquery/purl.js"></script>
<!-- we can't use the kb_shortcuts API because you can't keep the shift key held down in between keypresses -->
<script src="http://netgear.rohidekar.com/yurl/js/webtoolkit.md5.js"></script>
<script type="text/javascript" src="d3/d3.js"></script>
<script type="text/javascript" src="d3/d3.geom.js"></script>
<script type="text/javascript" src="d3/d3.layout.js"></script>
<script>


var host = "http://netgear.rohidekar.com";
var urlBase = "http://netgear.rohidekar.com:44447/yurl";
var rootId;
var parentOfRootId;
var orderedDescending = true;
var readyToRender = false;
var limit;
var uncategorizedResponse; // Populated via rest call
var categories; // Populated via rest call
var biggestImages = {};
var IMAGE_SIZE = 100; // for thumbnails
var imageSize = 300; // for cards

function initialize() {

	initializeBeforeAjax();
	
	////
	//// Uncategorized URLs (main part)
	////
    
	getUrls : {
		var url = host + ":44443/yurl/uncategorized?rootId=" +rootId;
		debugger;
		document.getElementById("url").href = url
		document.getElementById("url").innerHTML = url
		//$("url").html(url);
		//$("url").attr("href", url);
		$.getJSON(url, function(result) {
			uncategorizedResponse = result;
			renderIfReady();
		});
	}
	
	////
	//// Get the key bindings and categories (non-recursive)
	////
	
	setCategoriesAndConfigureKeyBindings : {
		$.getJSON(host + ":44440/yurl/keys?parentId=" + rootId, function(result){
			//var originalKeyBindings = 
				$.extend(true, {}, result);// TODO: what does this do?
			categories = result;
			renderIfReady();
		});
	}
	    
    ////
    //// Show a complete tree of categories
    ////
    
    // Unfortunately, there is no easy way to get a tree of all category nodes.
    // If this were an enterprise app, I'd go through the extra effort but for a 
    // toy app like this it's not worth the effort.
    var nodeIdZero = 0;
    getCategoriesTree : {
		var url = "http://netgear.rohidekar.com:44441/yurl/categoriesRecursive?parentId=" + nodeIdZero;
		$.getJSON(url, function(result){})
			.success(
				function(data) { 
					  
					  renderD3Visualization(data.categoriesTree);
					  
					  //writeCategoryTree(data.categoriesTree, 0);

					  //var children = findCategoryChildren(data.categoriesTree, rootId);
					  
					  /*
					  html += "-------OLD----------";
					  // TODO: stop using flat
					  $.each(data.flat, function(a,category,c){
							html += CATEGORY_TO_LINK("", category);
						});
						*/
					$("#categoriesRecursive").append(CATGORY_TREE_TO_LINKS_HTML(data.categoriesTree));
				}
			)
			.error(function() {  })
			.complete(function() {  }
		);
	}

	////
    //// Start listening for changes to the key binding assignments
    ////
    
    addKeyBindingsUpdateHandler : {
		var oldKeyBindings = null;
		$("#keys").focus(function() {
			oldKeyBindings = $.trim($("#keys").val());
		}).blur(function() {
			var newKeyBindings = $.trim($("#keys").val());
			if (oldKeyBindings === newKeyBindings) {
			} else {
				var url = host + ":44440/yurl/keysUpdate?parentId=" + $.url().param('rootId') + "&newKeyBindings=" + encodeURIComponent(newKeyBindings) + "&oldKeyBindings=" + encodeURIComponent(oldKeyBindings);
				$.getJSON(url, function(result){})
					.success(function(data) {  
						configureKeyBindings(data);
					})
					.error(function() { })
					.complete(function() { });
			}
		});
    }    
}

// Map function
function CATGORY_TREE_TO_LINKS_HTML(categoryNode) {
	var category = categoryNode;
	return "<input type=checkbox value=false name=" + category.id + ">"
		+ "<a href='/yurl/?rootId=" + category.id + "' style='text-transform:capitalize;'>"
		+ category.name + " (" + category.id + ")"
		+ "</a>"
		+ "</input>"
		+ "<br>"
		+ "<ul>"
		+ category.children.map(CATGORY_TREE_TO_LINKS_HTML).join("</li><li>")
		+ "</ul>"
		;
}

// Reduction function
function CATEGORY_TO_LINK(accumulator, categoryNode) {
	var category = categoryNode;
	return accumulator + "<input type=checkbox value=false name=" + category.id + ">"
		+ "<a href='/yurl/?rootId=" + category.id + "' style='text-transform:capitalize;'>"
		+ category.name + " (" + category.id + ")"
		+ "</a>"
		+ "</input>"
		+ "<br>";
}
	
function renderIfReady() {
console.debug('SRIDHAR 1');
console.log('SRIDHAR 1');
	if (!uncategorizedResponse) {
		return;
	}
	if (!uncategorizedResponse.categoriesRecursive) {
		debugger;
	}
	categories = getCategoriesUnderID2(uncategorizedResponse.categoriesRecursive, rootId);
	configureKeyBindings();
	$("#status").text("Populating");
	//var categoryOrdinal = 0;
	var categoryIdsToNames = getCategoryNamesMap(uncategorizedResponse.categoriesRecursive);
	var urls = uncategorizedResponse.urls;

	var categoryIdsUnderRootOrdered = putRootAtFront(urls, rootId);
	
	var cardsHtml = "";
	{
		var urlsRootOnly = uncategorizedResponse.urls[rootId];
		if (urlsRootOnly != null) {
			//var headLength = 10;
			//var truncated = 
			// This doesn't return the new list unfortunately. It will cause the thumbnails to also get truncated
			//urlsRootOnly.splice(headLength, urlsRootOnly.length - 1 - headLength);
			//console.debug("remaining elements: " + truncated.length + " of " + urlsRootOnly.length);
			var childCategories = findCategoryChildren(uncategorizedResponse.categoriesRecursive, rootId);
			cardsHtml = urlsRootOnly				
				.map(function(i){ if (i.ordinal < 9999999999) { i.ordinal = i.ordinal * 1000; }; return i;})
				.sort(function (u1, u2) {return u2.ordinal - u1.ordinal ;})
				.slice(0, limit)
				.map(ITEM_TO_HTML(childCategories, rootId, parentOfRootId)).join("\n");
				
			var imageUrlsTxt = urlsRootOnly				
				.map(function(i){ if (i.ordinal < 9999999999) { i.ordinal = i.ordinal * 1000; }; return i;})
				.sort(function (u1, u2) {return u2.ordinal - u1.ordinal ;})
				.map(ITEM_TO_IMAGE_URL);
			$("#imageUrls").append(imageUrlsTxt);
		}
	}
	var urlThumbnailsHtml = "";
	var urlListHtml = "";
	var tableHtml = "";
	var productsHtml = "";
	var markupHtml = "";
	var urlsHtml = "";
	for (var i = 0; i < categoryIdsUnderRootOrdered.length; ++i) {
		var categoryId = categoryIdsUnderRootOrdered[i];
		var categoryName = categoryIdsToNames[categoryId];
		var urlsForCategory = urls[categoryId];
		
		urlThumbnailsHtml += getCategoryThumbnailsHtml(categoryId, categoryIdsToNames[categoryId], urls[categoryId], limit);
		tableHtml += getCategoryTableHtml(categoryId, categoryName, urlsForCategory);
		urlListHtml += getCategoryListHtml(categoryId, categoryIdsToNames[categoryId], urls[categoryId]);
		productsHtml += getProductsHtml(categoryId, categoryName, urlsForCategory);
		markupHtml += "<h1>" + categoryName + "</h1>\n\n" + urlsForCategory.map(ITEM_TO_IMAGE).join("\n");
  		urlsHtml += urlsForCategory.map(ITEM_TO_URL).join("\n");
	}
	$("#url_cards").append(cardsHtml);
	$("#url_thumbnails").append(urlThumbnailsHtml);
	$("#url_table").append(tableHtml);
	$("#list").append(urlListHtml);
	$("#products").append(productsHtml);
	$("#htmlText").val(markupHtml);
	$("#urls").val(urlsHtml)
}

function initializeBeforeAjax() {

	////
	//// Determine the root ID
	////
	getRootId: {
		rootId = $.url().param('rootId');
	}

	updateURL: {
		if (rootId == null || rootId == '') {
			rootId = 45;
			history.pushState(null, null, '/yurl?rootId=' + rootId); // HTML5
		}
	}
	
	setCountAndTitle: {
		$.getJSON(host + ":44438/yurl/count_non_recursive?rootId=" +rootId,function(result){
			$("#count").text(result.count);
			$("#category").text(result.name);
			document.title = "4447 " + result.name.charAt(0).toUpperCase() + result.name.slice(1) + " (yurl)";
		});
	}

	setParentOfRootId(rootId);
	
	showLoading : {
		$("#status").text("Loading"); 			
	}

	setColorForCategory : {		
		var rootColor = MD5(rootId.toString()).substring(0,6);
		$("#rootColor").attr("style", "background-color: #" + rootColor);
	}

	limit = $.url().param('limit');
	if (limit == null) {
		limit = 500;
		window.history.pushState("object or string", "Title", document.URL + "&limit=" + limit);
	}
}

function fillThumbnailItem(resultRowNumber, field, result, limit, biggestImages, categories) {
	if (resultRowNumber > limit && resultRowNumber < result.length - 10)  {
		return;
	}
	var toBeAppended = createImageCell(field, biggestImages, IMAGE_SIZE, resultRowNumber);
	$("#url_thumbnails").append(toBeAppended);
	
}

function getDownloadedVideoColor(downloaded) {
	if ("null" == downloaded) {
		return "red";
	}
	if (!downloaded) {
		return "red";
	}
	return "green";
}

function ITEM_TO_URL(item) {
	return item.url;
}

function ITEM_TO_IMAGE(item) {
	return createImageCell(item)[0].outerHTML;
}

// Creates a JQquery DOM element
// field = item
function createImageCell(field) {

	var imageCell = "";
	var hasScreenshot = false;
	{
		if (field.url.match(".jpg\??") || 
			field.url.match(/.*jpg/i) ||
			field.url.match(".gif$") || 
			field.url.match(".png\??") || 
			field.url.match("images.q=tbn:")) {
			imageCell += ("<img class=itemImage src='"+field.url+"' height="+imageSize+" onmouseenter='zoom(this)' title='" +field.title+ "'>");
			hasScreenshot = true;
		}
		if (field.user_image != null) {
				imageCell += ("<img class=itemImage src=\""+ field.user_image +"\" class='screenshot' width="+imageSize+" />");
				hasScreenshot = true;		
		} else if (field.url.match("youtube.com")) {
			if (field.url.match("youtube.com/watch")) {
				var youtubeId = field.url.replace(/^https?:..www.youtube.com.watch.*v=([^&]+).*/g,'$1');
				imageCell += ("");
				imageCell += ("<img class=itemImage src='http://img.youtube.com/vi/"+youtubeId+"/0.jpg' width="+imageSize+" title='" +field.title+ "'>");
				
				imageCell += ("");
				imageCell += ("");
				imageCell += ("");
				hasScreenshot = true;
			}
			
		} else if (field.url.match("dailymotion.com/video")) {
				var youtubeId = field.url.replace(/^http.*video.([^?]+)(.*)/g,'$1');
				imageCell += ("");
				imageCell += ("<img class=itemImage src='http://dailymotion.com/thumbnail/video/"+youtubeId +"' width="+imageSize+" title='" +field.title+ "'>");
				imageCell += ("");
				imageCell += ("");
				imageCell += ("");
				hasScreenshot = true;
			
		} else if (field.url.match(".amazon.co[^/]+\/[^s]")) {
		//else if (false) {
			imageCell += ("");
			var asin = field.url.replace(/.+((dp)|(product))\/([^\/?]+)[\/?].*/,'$4');
			asin = asin.replace(/.*dp./,'');
			asin = asin.replace(/.*gp.aw.d./, '');
			asin = asin.replace(/.ref_?=.*/, '');
			asin = asin.replace(/.*offer-listing./, '');
			var productImageUrl = 'http://images.amazon.com/images/P/'+asin+'.01.LZZZZZZZ.jpg';
			imageCell += ("<img class=itemImage src='"+productImageUrl+"' height='280' title='" +field.title+ "'>");
			hasScreenshot = true;
		}
	}
	
	if (!hasScreenshot) {
		imageCell += ("<img class=itemImage src=\"http://free.pagepeeker.com/v2/thumbs.php?size=x&url="+encodeURIComponent(field.url)+"\" class='screenshot' width="+imageSize+" title='" +field.title+ "'/>");
		// Check if the biggest image server is up
		if (biggestImages != null) {
			if (biggestImages[field.url] != null) {
				imageCell += ("<img class=itemImage src=\""+ biggestImages[field.url] +"\" class='screenshot' width="+imageSize+" />");
			}
		}
	}

	// Tooltip
	var img = $($.parseHTML("<a href='"+field.url+"'  title='" +field.title+ "' >" + imageCell + "</a>"));
/*	img.tooltip({
		items: "img",
		content:  field.title + "<br><font style=\"font-size : xx-small \">"+field.url+"</font>",
	});	*/
	return img;
}


function ITEM_TO_IMAGE_URL(item2) {
	var field = item2;
	var imageCell = "";
	var hasScreenshot = false;
	{
		if (field.url.match(".jpg\??") || 
			field.url.match(/.*jpg/i) ||
			field.url.match(".gif$") || 
			field.url.match(".png\??") || 
			field.url.match("images.q=tbn:")) {
			imageCell += field.url;
			hasScreenshot = true;
		}
		if (field.user_image != null) {
				imageCell += field.user_image;
				hasScreenshot = true;		
		} else if (field.url.match("youtube.com")) {
			if (field.url.match("youtube.com/watch")) {
				var youtubeId = field.url.replace(/^https?:..www.youtube.com.watch.*v=([^&]+).*/g,'$1');
				imageCell += "http://img.youtube.com/vi/"+youtubeId+"/0.jpg";
				hasScreenshot = true;
			}
		
		} else if (field.url.match("dailymotion.com/video")) {
				var youtubeId = field.url.replace(/^http.*video.([^?]+)(.*)/g,'$1');
				imageCell += "http://dailymotion.com/thumbnail/video/"+youtubeId ;
				hasScreenshot = true;
		
		} else if (field.url.match(".amazon.co[^/]+\/[^s]")) {
			var asin = field.url.replace(/.+((dp)|(product))\/([^\/?]+)[\/?].*/,'$4');
			asin = asin.replace(/.*dp./,'');
			asin = asin.replace(/.*gp.aw.d./, '');
			asin = asin.replace(/.ref_?=.*/, '');
			asin = asin.replace(/.*offer-listing./, '');
			var productImageUrl = 'http://images.amazon.com/images/P/'+asin+'.01.LZZZZZZZ.jpg';
			imageCell += productImageUrl;
			hasScreenshot = true;
		}
	}

	if (!hasScreenshot) {
		imageCell += "http://free.pagepeeker.com/v2/thumbs.php?size=x&url="+encodeURIComponent(field.url);
		// Check if the biggest image server is up
		if (biggestImages != null) {
			if (biggestImages[field.url] != null) {
				imageCell += biggestImages[field.url];
			}
		}
	}
	return imageCell + "\n";
}

function relateNew(newParentId, currentRootId, button) {
	if (newParentId == null) {
		alert("newParentId = " + newParentId);
		return;
	}

	var liElem = button.parentElement.parentElement.parentElement.parentElement.parentElement;
	var url 		= $(liElem).attr("url");
	var created 	= $(liElem).attr("created");
	var categoryId 	= $(liElem).attr("categoryId");
	
	var url = urlBase + "/relate?parentId=" +newParentId+"&url=" +  encodeURIComponent(url) + "&currentParentId=" + categoryId + "&created=" + created;	
	var parentId = newParentId;
	
	removeTopNew(newParentId, liElem);
	//
	// The main part
	//
	$.getJSON(url, function(result){})
		.success(function() { 

			$("#list_"+parentId).effect("highlight", null, 4000, function() {});
			
			// Change the destination category count
			var count = parseInt($("#count_"+parentId).text()) + 1;
			$("#count_"+parentId).text(count);
			$("#count_"+parentId).css("font-weight","Bold");
			
			// Decrement the number of items in this category that is displayed
			var newCount = parseInt($("#count").text());
			newCount -= 1;
			$("#count").text(newCount);
		})
		.error(function() { alert("error occurred : " + url); })
		.complete(function() { });
}

function relate(parentId, childId, currentRootId) {
	removeTop(parentId, childId);
	var url = urlBase + "/relate?parentId=" +parentId+"&childId=" +  childId + "&currentParentId=" + currentRootId;	
	//
	// The main part
	//
	$.getJSON(url, function(result){})
		.success(function() { 

			$("#list_"+parentId).effect("highlight", null, 4000, function() {});
			
			// Change the destination category count
			var count = parseInt($("#count_"+parentId).text()) + 1;
			$("#count_"+parentId).text(count);
			$("#count_"+parentId).css("font-weight","Bold");
			
			// Decrement the number of items in this category that is displayed
			var newCount = parseInt($("#count").text());
			newCount -= 1;
			$("#count").text(newCount);
		})
		.error(function() { alert("error occurred " + url); })
		.complete(function() { });
}

function createAndRelate(childId, currentRootId) {
	var newParentName = prompt('Category name:');
	removeTopNoDest(childId);
	var url = urlBase + "/createAndRelate?newParentName=" +encodeURIComponent(newParentName)+"&childId=" +  childId + "&currentParentId=" + currentRootId;	
	//
	// The main part
	//
	$.getJSON(url, function(result){})
		.success(function() { 
		})
		.error(function() { alert("error occurred " + url); })
		.complete(function() { });
}

// This part just performs frontend changes, nothing backend
function removeTopNoDest(childId) {

		$($("#" + childId)).effect( "blind",null, 5, function() { $(this).remove(); });

}

// This part just performs frontend changes, nothing backend
function removeTopNew(parentId, itemElem) {
	var target;
	if (parentId == parentOfRootId) {
		target = "#up";
	} else {
		target = "#list_"+parentId;
	}
	var options = { to: target, className: "ui-effects-transfer" };
	$($(itemElem)).effect('transfer', options, 50, function() { // !!!!!!!! TODO : Wrong. remove the one specified by child ID
		$($(itemElem)).effect( "blind",null, 5, function() { $(this).remove(); });
	});	
}

// This part just performs frontend changes, nothing backend
function removeTop(parentId, childId) {
	var target;
	if (parentId == parentOfRootId) {
		target = "#up";
	} else {
		target = "#list_"+parentId;
	}
	var options = { to: target, className: "ui-effects-transfer" };
	$($("#" + childId)).effect('transfer', options, 50, function() { // !!!!!!!! TODO : Wrong. remove the one specified by child ID
		$($("#" + childId)).effect( "blind",null, 5, function() { $(this).remove(); });
	});	
}
  
// Delete. Redundant functionality
function writeCategoryTree(root, level) {
	var indent = "";
	for (var i = 0; i < level; i++) {
		indent = indent + "&nbsp;&nbsp;&nbsp;&nbsp;";
	}
	$("#categoriesTree").append(indent + "<a href='/yurl/?rootId="+root.id+"' style='text-transform:capitalize;'>"+root.name + "</a>");
	$("#categoriesTree").append("<br>");
	
	if (root.children != null) {
		$.each(root.children, function(a,b){
			writeCategoryTree(b, level + 1);
		});
	}
}

function moveToTop(source, button) {
	var idToMove = source;
	var firstId = $("#url_cards").children().first().attr("id");

	var liElement = button.parentElement.parentElement.parentElement.parentElement.parentElement;

	var url = liElement.getAttribute('url');
	var categoryId = liElement.getAttribute('categoryId');
	var created = liElement.getAttribute('created');
	if (orderedDescending) {
		var elem = $(liElement).remove();
		$("#url_cards").prepend(elem);
		// 1 more than latest timestamp
		$.getJSON(host + ":44439/yurl/surpassOrdinal?url=" + encodeURIComponent(url) + "&categoryId=" + categoryId + "&created=" + created,
			function(result){
			})
			.success(function(data) {  
			})
			.error(function() {
				alert("error occurred 4439"); 
			})
			.complete(function() { });
	} else {
		// 1 less than earliest timestamp
		alert('not implemented');
	}
}

function moveToBottom(source) {
	var idToMove = source;
	var lastId = $("#url_cards").children().last().attr("id");

	if (orderedDescending) {
		var elem = $("#" + idToMove).remove();
		$("#url_cards").append(elem);
		$.getJSON(host + ":44439/yurl/undercutOrdinal?nodeIdToChange=" + idToMove + "&nodeIdToUndercut=" + lastId, 
			function(result){
			})
			.success(function(data) {  
			})
			.error(function() {
				alert("error occurred 4439"); 
			})
			.complete(function() { });
	} else {
		alert('not implemented');
	}
}

function moveUp(source) {
// 	var first = $("#" + source).prev().attr('id');
// 	var second = source;
// 	swap(first, second);
	alert("Needs reimplementing 1");
}

function moveDown(source) {
// 	var first = source;
// 	var second = $("#" + source).next().attr('id');
// 	swap(first, second);

	alert("Needs reimplementing 2");
}

function swap(firstId, secondId) {
// 	$.getJSON(host + ":44439/yurl/swapOrdinals?firstId=" + firstId + "&secondId=" + secondId, 
// 		function(result){
// 		})
// 		.success(function(data) {  
// 			$("#" + secondId).after($("#" + firstId));
// 		})
// 		.error(function() { 
// 			alert("error occurred "); 
// 		})
// 		.complete(function() { 
// 		});

	alert("Needs reimplementing 3");

}

function sendBatch() {
	var urls = encodeURIComponent($("#urlBatchToSend").val());
	$("#batchStatus").text("Sending new batch");	
	$.getJSON(urlBase + "/batchInsert?rootId=" + rootId + "&urls=" + urls, function(result){})
		.success(function(data) {
			$("#batchStatus").text("Successfully imported batch, except for ones remaining in text box");
			$("#urlBatchToSend").val("");
			$("#urlBatchToSend").val(data.unsuccessful);
		})
		.error( function(data) {
			alert("error occurred " + urlBase); 
		} )
		.complete( function() {} );
}

function createArrayWithId(id) {
	var selected = new Array();
	selected.push(id);
	return JSON.stringify(selected);
}


function getTagSelections() {
	var selected = new Array();
	$('#categoriesRecursive input:checked').each(function() {
		selected.push($(this).attr('name'));
	});
	return JSON.stringify(selected);
}

function tagUrlWithSelections(nodeId) {
	var selections = getTagSelections();
	tagUrlWithCategoryIds(nodeId, selections);
}

function tagUrlWithCategoryIds(nodeId, selections, button) {
	var url = urlBase + "/relateCategoriesToItem?nodeId=" + nodeId + "&newCategoryIds=" + encodeURIComponent(selections);
	$.getJSON(url, 
		function(result){
		})
		.success(function(data) {
			button.style.cssText = "background-color : green";
		})
		.error(function() { 
			alert("error occurred " + url); 
		})
		.complete(function() { 
		}
	);
}

function setParentOfRootId(nodeId) {    	
	$.getJSON(urlBase + "/parent?nodeId=" + nodeId, function(result){
	})
	.success(function(data) {  
		if (data[0] != null) {
			parentOfRootId = data[0].id;
			$("#up").attr("href", "/yurl/?rootId=" + parentOfRootId);
		}
	})
	.error(function() { })
	.complete(function() { });
}

$(function() {
	$( "#tabs" ).tabs();
});

// TODO: Remove. Unused
function addEmbeddedVideo(id, url) {
	$("#" + id).children().last().append("<iframe width=420 height=345 src="+url.replace("watch?v=","embed/")+"></iframe>");
}

// TODO: Remove. Unused
function getBiggestImages() {
	$.getJSON("http://localhost:3000/biggestImages", function(result){
		biggestImages = result;
		initialize();
	});
}

function findCategoryChildren(categoriesNode, categoryIdToFind) {
	if (categoriesNode.id == categoryIdToFind || categoriesNode.id == parseInt(categoryIdToFind)) {
		return categoriesNode.children;
	}
	else if (categoriesNode.children != null) {
		for (var i = 0; i < categoriesNode.children.length; i++ ) {
			var category = findCategoryChildren(categoriesNode.children[i], categoryIdToFind);
			if (category != null) {
				return category;
			}
		}
	} else {
		return null;
	}
}

function ITEM_TO_HTML(categories, currentCategoryId, parentCategoryId, item) {
	return function (item) {
		return fillCardItem(null, item, null, null, null, categories);
	};
}

function putRootAtFront(urls, rootId) {
	var categoryIdsUnderRoot = Object.keys(urls);
	var first = categoryIdsUnderRoot.splice(categoryIdsUnderRoot.indexOf(rootId),1);
	var categoryIdsUnderRootOrdered = first.concat(categoryIdsUnderRoot);
	return categoryIdsUnderRootOrdered;
}

function getCategoryTableHtml(categoryId, categoryName, urlsInCategory) {
		var html = "<h3>" + categoryName + " (" + categoryId + ")</h3>";
		html += "<table id='table-"+categoryId+"' class='sortable urlTable'>";
		html += "<thead><th>Title</th><th>URL</th></thead>";
		html += "<tbody>";
		for (var j = 0; j < urlsInCategory.length; j++) {
			var item = urlsInCategory[j];
			html += "<tr>";
			html += "<td><div class='truncate'>" + item.title + "</div><td>";
			html += "<td><div class='truncate'>" + item.url + "</div><td>";
			html += "</tr>";
		}
		html += "</tbody>";
		html += "</table>";
		return html;
}

function getCategoryThumbnailsHtml(categoryId, categoryName, urlsInCategory1, limit) {

		var urlsInCategory = urlsInCategory1.map(function(i){ if (i.ordinal < 9999999999) { i.ordinal = i.ordinal * 1000; }; return i;}).sort(function (u1, u2) {return u2.ordinal - u1.ordinal ;});
		var urlThumbnailsHtml = "<h3><a href='/yurl/?rootId="+categoryId+"'>" + categoryName + " (" + categoryId + ")</a></h3>";
		for (var j = 0; j < urlsInCategory.length; j++) {

			if (j > limit) {
				break;
			}
			var item = urlsInCategory[j];

			if (item == null) {
				debugger;
				continue;
			} else {
				console.log('SRIDHAR item.url = ' + item.url);
			}
			var displayImageUrl = getDisplayImageUrl(item);
			urlThumbnailsHtml += "<a href="+item.url+"><img class=itemImage src='"+displayImageUrl+"' height="+IMAGE_SIZE+" onmouseenter='zoom(this)'></a>" ;
		}
		return urlThumbnailsHtml;
}

function getDisplayImageUrl(item) {
	var url = item.url;
	var specialSiteImageUrl = getSpecialSiteUrl(url);
	if (url.match(".jpg\??") || url.match(/.*jpg/i) || url.match(".gif$")
			|| url.match(".png\??") || url.match("images.q=tbn:")) {
		displayImageUrl = url;
	} else if (specialSiteImageUrl != null) {
		displayImageUrl = specialSiteImageUrl;
	} else if (item.user_image != null) {
		displayImageUrl = item.user_image;
	} else if (item.biggest_image != null) {
		displayImageUrl = item.biggest_image;
	} else if (url.match(".amazon.co[^/]+\/[^s]")) {
		var asin = url.replace(/.+((dp)|(product))\/([^\/?]+)[\/?].*/,'$4');
		asin = asin.replace(/.*dp./,'');
		asin = asin.replace(/.*gp.aw.d./, '');
		asin = asin.replace(/.ref_?=.*/, '');
		asin = asin.replace(/.*offer-listing./, '');
		var productImageUrl = 'http://images.amazon.com/images/P/'+asin+'.01.LZZZZZZZ.jpg';
		displayImageUrl = productImageUrl;
	} else {
		displayImageUrl = "http://free.pagepeeker.com/v2/thumbs.php?size=x&url="
				+ encodeURIComponent(url);
	}
	return displayImageUrl;
}

function getImageForUrl(url) {
	var imageUrl;
	if (url.match(".jpg\??") || 
		url.match(/.*jpg/i) ||
		url.match(".gif$") || 
		url.match(".png\??") || 
		url.match("images.q=tbn:")) {
		imageUrl = url;
	} else {
		var specialSiteImageUrl = getSpecialSiteUrl(url);
		if (specialSiteImageUrl == null) {
			imageUrl = "http://free.pagepeeker.com/v2/thumbs.php?size=x&url="+encodeURIComponent(url);
		} else {
			imageUrl = specialSiteImageUrl;
		}
	} 
	return imageUrl;
}

function getSpecialSiteUrl(url) {
	var imageUrl;
	if (url.match("youtube.com/watch")) {
		var youtubeId = url.replace(/^https?:..www.youtube.com.watch.*v=([^&]+).*/g,'$1');
		imageUrl = "http://img.youtube.com/vi/"+youtubeId+"/0.jpg";	
	} else if (url.match("dailymotion.com/video")) {
		var youtubeId = url.replace(/^http.*video.([^?]+)(.*)/g,'$1');
		imageUrl = "http://dailymotion.com/thumbnail/video/"+youtubeId ;			
	}
	// Too unreliable
//	else if (url.match(".amazon.co[^/]+\/[^s]")) {
//		var asin = url.replace(/.+((dp)|(product))\/([^\/?]+)[\/?].*/,'$4');
//		asin = asin.replace(/.*dp./,'');
//		asin = asin.replace(/.*gp.aw.d./, '');
//		asin = asin.replace(/.ref_?=.*/, '');
//		asin = asin.replace(/.*offer-listing./, '');
//		var productImageUrl = 'http://images.amazon.com/images/P/'+asin+'.01.LZZZZZZZ.jpg';
//		imageUrl = productImageUrl;
//	} 
	else {
		imageUrl = null;
	}
	return imageUrl;
}

function getProductsHtml(categoryId, categoryName, urlsInCategory) {
		var productsHtml = "<h3>" + categoryName + " (" + categoryId + ")</h3>";
		for (var j = 0; j < urlsInCategory.length; j++) {
			var item = urlsInCategory[j];
			
			if (item.url.match(".amazon.co[^/]+\/[^s]")) {
				productsHtml += "";
				var asin = item.url.replace(/.+((dp)|(product))\/([^\/?]+)[\/?].*/,'$4');
				asin = asin.replace(/.*dp./,'');
				asin = asin.replace(/.*gp.aw.d./, '');
				asin = asin.replace(/.ref_?=.*/, '');
				asin = asin.replace(/.*offer-listing./, '');
				var productImageUrl = 'http://images.amazon.com/images/P/'+asin+'.01.LZZZZZZZ.jpg';
				var imageTag = ("<img class=itemImage src='"+productImageUrl+"' height='280'>");
				productsHtml += "<a href='" + item.url +"'>" + imageTag + "</a>\n";
				hasScreenshot = true;
			} else {
				productsHtml += item.url + "<br>";
			}
		}
		return productsHtml;
}

function getCategoryListHtml(categoryId, categoryName, urlsInCategory) {
		var urlThumbnailsHtml = "<h3>" + categoryName + " (" + categoryId + ")</h3>";
		for (var j = 0; j < urlsInCategory.length; j++) {
			var item = urlsInCategory[j];
			urlThumbnailsHtml += item.title + " (<a href='" + item.url +"'>" + item.url + "</a>)<br><br>";
		}
		return urlThumbnailsHtml;
}

function fillCardItem(resultRowNumber, field, result, limit, biggestImages, categories) {
	if (resultRowNumber != null && result != null && limit != null) {	
		if (resultRowNumber > limit && resultRowNumber < result.length - 10)  {
			return;
		}
	}
	
	//var one = $("<td style='background-color:'>1");
	var two = $("<td style='background-color:' >2");
	var three = $("<td style='background-color:'>3");
	var four = $("<td id='categoryButtonsCell' style='background-color:'>4");
	var five = $("<td style='background-color:'>5");
	var six = $("<td style='background-color:'>6");
	
	var listItem;
	var table = $("<table/>");
	{
		table.attr('width','100%');
	
		{
			var row1 = $("<tr/>");
			table.append(row1);
			row1.append(two);
			row1.append(three);
		}
	
		{
			var row2 = $("<tr/>");
			table.append(row2);
			row2.append(four);
			row2.append(five);
			row2.append(six);
		}
	
		{
			listItem = $("<li>").attr('id',field.id).attr("class",'buttonize').attr('style','background-color:#FDFD96')
				.attr('url',field.url)
				.attr('created',field.created)
				.attr('categoryId',rootId);
			listItem.append(table);
			//$("#url_cards").append(listItem);
		}
	
	}
	
	{
		var urlElements = field.url.match(/^http:\/\/[^\/]+/);
		if (urlElements != null) {
			var site = urlElements[0];
			two.append("<img src='" + site + "/favicon.ico' width=18 onerror=\"this.style.display='none'\" > ");
		}
		var date;
		if (field.created < 9999999999) {
			field.created = field.created * 1000;
		} 
		var dddd = (new Date(field.created)).toString();
		two.append("<font style=\"color: #002366 ; font-weight : normal; font-size: medium\">"+ field.title + "</font><br><sub><font style=\"color: #436B95\"><a href='" +field.url+"'>"+field.url+"</a></font><br>"+field.created+" - "+dddd+"<br>"+"</sub>");
	}
	
	var imageCell = createImageCell(field, biggestImages, null, resultRowNumber);
	three.append(imageCell);
	
	if (field.parentId != null) {
		six.append("Parent ID: " + field.parentId);
	}
	
	{
		var buttonCell = two;
		buttonCell.append("<br>");
		buttonCell.append("<br>");
		buttonCell.append("<input type=button class='genericButton' value=Tag onClick='tagUrlWithSelections("+field.id+")'><br>");			
		buttonCell.append("<input type=button class='genericButton' value='Wrong Category' onClick='relateNew("+parentOfRootId+","+rootId+",this)'><br>");
		buttonCell.append("<br>");
		buttonCell.append("<input type=button class='genericButton' value='Change Image' onClick='changeImage("+field.id+",this,\"" +field.url+ "\")'><br>");
		buttonCell.append("<input type=button class='genericButton' value='Remove Custom Image' onClick='removeImage("+field.id+",this,\"" +field.url +"\"," + rootId + ")'><br>");
		buttonCell.append("<br>");
		buttonCell.append("<br>");
		buttonCell.append("<input type=button class='genericButton' value='Top' onclick='moveToTop("+field.id+", this)'><br>");
		buttonCell.append("<input type=button class='genericButton' value='Move Up' onclick='moveUp("+field.id+")'><br>");
		buttonCell.append("<input type=button class='genericButton' value='Move Down' onclick='moveDown("+field.id+")'><br>");
		buttonCell.append("<input type=button class='genericButton' value='Bottom' onclick='moveToBottom("+field.id+")'><br>");
		buttonCell.append("<sub>"+field.id+"</sub>");
	}
	
	{
		var categoryButtons = four;
		if (categories && categories.length == 0) {
			// TODO: 'categories' may not yet be set. Really we should add these buttons in the callback where "categories" is set. But we don't know the field ID unless we wait until the item results load
			debugger;
		} 
		if (categories) {
			var html = categories.sort(COMPARE_OBJ_NAME).map(CATEGORY_TO_BUTTON(field.id, rootId)).join("&nbsp;");
			categoryButtons.append(html);
			// TODO: would be nice to use map and fold
			//$.each(categories, function(a,binding,c){
			//	categoryButtons.append("<input type=button class='genericButton' value='"+binding.name+" ("+ binding.key+")' onclick='relate("+binding.id+","+field.id+","+rootId+")'>&nbsp;");
			//});
		}
		categoryButtons.append("<br>");
		categoryButtons.append("<br>");
		categoryButtons.append("<input type=button class='genericButton' value='NEW' onclick='createAndRelate("+field.id+","+rootId+")'>&nbsp;");
	}
	
	{
		five.append("<input type=button class='genericButton' value='I own this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+37373+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Buy this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+221013+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Download this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+221026+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Downloaded this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+ 322410 +"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Watched' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+37652+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Watch this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+37567+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Documentary' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+37659+"), this)'><br>");

		five.append("<input type=button class='genericButton' value='Find in Library' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+ 608592+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='PDF owned' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+ 641476+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Priority 3' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+38907+"), this)'><br><br>");
//		five.append("<input type=button class='genericButton' value='Save Video' onclick='alert(\"saved\")' style='background-color : blue'><br>");
		five.append("<input type=button class='genericButton' value='Save Video' onclick='downloadVideo("+field.id+",\""+ field.url +"\", this)' style='background-color : "+getDownloadedVideoColor(field.downloaded_video)+"'><br>");
//encodeURIComponent(field.url)+
		
	}	
	return listItem[0].outerHTML;
}


function removeImage(id, button, url, parentId) {
        // TODO : prepopulate with the computed thumbnail
                $.getJSON(urlBase + '/removeImage?id=' + id + "&parentId=" + parentId, 
                        function(result){
                                console.debug(result);
                        })
                        .success(function(data) {
                                button.style.cssText = "background-color : green";
                        })
                        .error(function() { 
                                alert("error occurred " + urlBase); 
                        })
                        .complete(function() { 
                        }
                );
}

function changeImage(id, button, url) {
	// TODO : prepopulate with the computed thumbnail
	var newImageUrl = prompt("Enter a new image URL:", prepopulatedImage(url));
	if (newImageUrl.length > 0) {
		$.getJSON(urlBase + '/updateImage?linkUrl='+encodeURIComponent(url)+'&url=' + encodeURIComponent(newImageUrl) + "&categoryId=" + rootId, 
			function(result){
				console.debug(result);
			})
			.success(function(data) {
				button.style.cssText = "background-color : green";
			})
			.error(function() { 
				alert("error occurred " + urlBase); 
			})
			.complete(function() { 
			}
		);
	}
}

// This can be refactored, but whatever
function prepopulatedImage(url) {

	var prepopulated = "";

	if (url.match(".jpg\??") || 
		url.match(/.*jpg/i) ||
		url.match(".gif$") || 
		url.match(".png\??") || 
		url.match("images.q=tbn:")) {
		
		// nothing to do

	}
	if (url.match("youtube.com")) {
		if (url.match("youtube.com/watch")) {
			var youtubeId = url.replace(/^https?:..www.youtube.com.watch.*v=([^&]+).*/g,'$1');
			prepopulated = "http://img.youtube.com/vi/"+youtubeId+"/0.jpg";
			
		}
		
	} else if (url.match("dailymotion.com/video")) {
			var youtubeId = url.replace(/^http.*video.([^?]+)(.*)/g,'$1');
			prepopulated = "http://dailymotion.com/thumbnail/video/"+youtubeId;
		
	} else if (url.match(".amazon.co[^/]+\/[^s]")) {

		var asin = url.replace(/.+((dp)|(product))\/([^\/?]+)[\/?].*/,'$4');
		asin = asin.replace(/.*dp./,'');
		asin = asin.replace(/.*gp.aw.d./, '');
		asin = asin.replace(/.ref_?=.*/, '');
		asin = asin.replace(/.*offer-listing./, '');
		prepopulated = 'http://images.amazon.com/images/P/'+asin+'.01.LZZZZZZZ.jpg';
	}
	return prepopulated;
}

function downloadVideo(id, url, buttonElement) {
	$.getJSON(urlBase + "/downloadVideo?url=" + encodeURIComponent(url) + "&id=" + id, function(result) {
		buttonElement.style.backgroundColor = getDownloadedVideoColor(true);
		console.debug("downloaded");
	});
	buttonElement.style.backgroundColor = "orange";
}

function CATEGORY_TO_BUTTON(itemId, currentCategoryId, categoryNode) {
	return function(categoryNode) {
		return "<input type=button class='genericButton' "
			+ " value='"+categoryNode.name+" ("+ categoryNode.key+")'"
			+ " onclick='relateNew("+categoryNode.id+","+currentCategoryId+", this)'>"
			+ "";
	};
}

function COMPARE_OBJ_NAME(categoryNode1, categoryNode2) {
	return categoryNode1.name.toUpperCase().charCodeAt(0) - categoryNode2.name.toUpperCase().charCodeAt(0);
}

function getCategoriesUnderID2(categoryTree, categoryId) {
	if (categoryTree.id == categoryId) {
		return categoryTree.children;
	} else if (categoryTree.children) {
		for (var i = 0; i < categoryTree.children.length; i++) {
			var child = categoryTree.children[i];
			if (child) {
				var match = getCategoriesUnderID2(child, categoryId);
				if (match) {
					return match;
				}
			}
		}
		return null;// Do not return an empty list here, the recursive logic will break.
	} else {
		return null;
	}
}

function getCategoriesUnderID(categories, categoryId) {
	for (var i = 0; i < categories.length; i++) {
		if (categories[i].id == categoryId) {
			return categories[i].children;
		} else {
			if (categories[i].children) {
				var ret = getCategoriesUnderID(categories[i].children,categoryId);
				if (ret) {
					return ret;
				}
			}
		}
	}
	return [];
}

function configureKeyBindings() {
	if (categories != null) {
		$.each(categories, function(a,binding,c){
			if (binding.key == 'null') {
				$("#keys").append("#");
				// Don't remove the "null" otherwise we'll assign hash to this category
			}
			$("#keys").append(binding.key + "=" + binding.name +" # node " + binding.id + "\n");
			$("#keyLinks").append("<li style='text-transform:capitalize;' id='list_"+binding.id+"'><a href='/yurl/?rootId=" + binding.id+ "'>" + " " + binding.name + " (<span id='count_"+binding.id+"'></span>)</a></li>");
			$("#count_" + binding.id).text(binding.count);
			$(window).keypress(function(event) {
				if ($("#keys").is(":focus")) {
					return;
				}
				if (binding.key == String.fromCharCode(event.which)) {
					var parentId = binding.id;
					var childId = $("#url_cards").children()[0].id;
					var currentRootId = rootId;
					relate(parentId, childId, currentRootId);
				}
			});			
		});
	}
	$(window).keypress(function(event) {
		console.debug("Needs reimplementing: key bindings");
// 		var key = String.fromCharCode(event.which);
// 		if (('_' == key)||('-'==key) ||('j'==key)|| ('n' == key) ) {
// 			var idOfTop = $("#url_cards").children()[0].id;
// 			moveToBottom(idOfTop);
// 		}
// 		if (String.fromCharCode(event.which) == '<') {
// 			var parentId = parentOfRootId;
// 			var childId = $("#url_cards").children()[0].id;
// 			var currentRootId = rootId;
// 			relate(parentId, childId, currentRootId);
// 		}
// 		if (String.fromCharCode(event.which) == '>') {
// 			console.debug("remove from list (deal with it later)");
// 		}
	});
}
//----------------------------------------------------------------------------------------
// D3 Visualization
//----------------------------------------------------------------------------------------

function drawVisualization(data) {
	console.debug(data);
	//var ua = navigator.userAgent;
	var forceDirectedGraph = new $jit.ForceDirected({
		injectInto: 'infovis',
		Node: {
			overridable: true
		},
		Edge: {
			overridable: true,
		},
		Label: {  
			type: 'Native', //Native or HTML  
			size: 5,  
			style: 'bold'  
		  },
		Navigation: {  
			enable: true,  
			//Enable panning events only if we're dragging the empty  
			//canvas (and not a node).  
			panning: 'avoid nodes',  
			zooming: 10 //zoom speed. higher is more sensible  
		},
	});

	var listOfNodes;
  
	{
		var adjacenciesList = [];
		for (var i = 0; i < data.children.length; i++) {
			adjacenciesList[i] = { "nodeTo" : data.children[i].id };
		}
		
		
		listOfNodes = [{
		
			id:45,
			data : {
				"$color"		:	"#C74243",
				"$type"			:	"star",
				"$dim"			: 	17
			},
			adjacencies : adjacenciesList
		}];
		
		addNodes(data, listOfNodes, 0);
	}

	forceDirectedGraph.loadJSON(listOfNodes); 

	forceDirectedGraph.computeIncremental({
		onComplete: function(){
			forceDirectedGraph.animate(function(){ });
		}
	});
	 
}

function addNodes(data, listOfNodes, level1) {
	if (data.children == null) {
		return;
	}
	++level1;
	for (var i = 0; i < data.children.length; i++) {
		var category = data.children[i];
		listOfNodes.push({ 
			id : category.id,
			name : category.name,
			"level" : level1,
			data : {
				"$color"		:	getColorForLevel(level1),
				"$type"			:	getShapeForLevel(level1),
				"$dim"			: 	4
			},
			adjacencies : getAdjacencies(category),
		});
		
		addNodes(category, listOfNodes, level1);
	}
}


function getColorForLevel(level) {
	if (level == 1) {
		return "red";
	}
	if (level == 2) {
		return "green";
	}
	if (level == 3) {
		return "blue";
	}
	return "yellow";
}

function getShapeForLevel(level) {
	if (level == 1) {
		return "star";
	}
	if (level == 2) {
		return "square";
	}
	if (level == 3) {
		return "triangle";
	}
	return "circle";
}

function getAdjacencies(category) {
	var adjacenciesList = [];
	
	if (category.children !=null) {
		for (var i = 0; i < category.children.length; i++) {
			adjacenciesList[i] = { "nodeTo" : category.children[i].id };
		}
	}
	return adjacenciesList;
}


function getCategoryNamesMap(categoriesRecursive) {
	var categoriesMap = {};
	if (categoriesRecursive.id == null) {
		debugger;
	}
	categoriesMap[categoriesRecursive.id] = categoriesRecursive.name;
	for (var category in categoriesRecursive.children) {
		var categoryNames = getCategoryNamesMap(categoriesRecursive.children[category]);
		categoriesMap  = $.extend(true, categoriesMap, categoryNames);
//                        categoriesMap.concat(categoryNames);
	}
	return categoriesMap;
}

function renderD3Visualization(flareJson) {
	var w = 680,
		h = 500,
		node = null,
		link = null,
		root;
	
	
	var force = d3.layout.force()
		.on("tick", tick) // Without this there is no recursive layout, and the graph just stays in one disorganized mess
	//    .charge(function(d) { return d._children ? -d.size / 100 : -30; })
	//    .linkDistance(function(d) { return d.target._children ? 80 : 30; })
		.size([w, h - 160])
		;
	
	var vis = d3.select("#d3").append("svg:svg")
		.attr("width", w)
		.attr("height", h);

	// I find this ridiculously complicated for adding hover text to a circle, but it 
	// works		
	var tooltip = d3.select("#d3")
		.append("div")
		.style("position", "absolute")
		.style("z-index", "10")
		.style("visibility", "hidden")
		.text("a simple tooltip");
		
	$("#d3").hide();
	
	// populate the graph with our input data
	{
	  root = flareJson;
	  root.fixed = true;
	  root.x = w / 2;
	  root.y = h / 2 - 80;
	  update();
	}
	
	// When an internal node is clicked to collapse the children, or initial load
	function update() {
	  var nodes = flatten(root),
		  links = d3.layout.tree().links(nodes);
	
	  // Restart the force layout.
	  force
		  .nodes(nodes)
		  .links(links)
		  .start();
	
	  // Update the links…
	  link = vis.selectAll("line.link")
		  .data(links, function(d) { return d.target.id; });
	
	  // Enter any new links.
	  link.enter().insert("svg:line", ".node")
		  .attr("class", "link")
		  .attr("x1", function(d) { return d.source.x; })
		  .attr("y1", function(d) { return d.source.y; })
		  .attr("x2", function(d) { return d.target.x; })
		  .attr("y2", function(d) { return d.target.y; });
	
	  // Exit any old links.
	  link.exit().remove();
	
	  // Update the nodes…
	  node = vis.selectAll("circle.node")
		  .data(nodes, function(d) { return d.id; })
		  .style("fill", color);
	
	  node.transition()
		  .attr("r", function(d) { 
			return d.size > 0 ? Math.max(Math.sqrt(d.size), 4.5) : 4.5;
		  });
	
		// Enter any new nodes.
		// You can’t add text elements to circle elements because circle elements are not containers; 
		var whatisthis = node.enter().append("svg:circle")
			.attr("class", "node")
			.attr("cx", function(d) { return d.x; })
			.attr("cy", function(d) { return d.y; })
			.attr("r", function(d) { 
				return d.size > 0 ? Math.max(Math.sqrt(d.size), 4.5) : 4.5;
			});
		  	
		whatisthis
			.on("mouseover", function(){return tooltip.style("visibility", "visible");})
			.on("mousemove", function(d){tooltip.text(d.name);return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
			.on("mouseout", function(){return tooltip.style("visibility", "hidden");});
	  
		whatisthis.style("fill", color)
		  .on("click", click)
		  .call(force.drag);      

		// Exit any old nodes.
		node.exit().remove();
	}
	
	function tick() {
	  link.attr("x1", function(d) { return d.source.x; })
		  .attr("y1", function(d) { return d.source.y; })
		  .attr("x2", function(d) { return d.target.x; })
		  .attr("y2", function(d) { return d.target.y; });
	
	  node.attr("cx", function(d) { return d.x; })
		  .attr("cy", function(d) { return d.y; });
	}
	
	// Color leaf nodes orange, and packages white or blue.
	function color(d) {
	  return d._children ? "red" : d.children ? "green" : "yellow";
	}
	
	// Toggle children on click.
	function click(d) {
	 console.debug(d.name);
	  if (d.children) {
		d._children = d.children;
		d.children = null;
	  } else {
		d.children = d._children;
		d._children = null;
	  }
	  update();
	}
	
	// Returns a list of all nodes under the root.
	function flatten(root) {
	  var nodes = [], i = 0;
	
	  function recurse(node) {
		if (node.children) node.size = node.children.reduce(function(p, v) { return p + recurse(v); }, 0);
		if (!node.id) node.id = ++i;
		nodes.push(node);
		return node.size;
	  }
	
	  root.size = recurse(root);
	  return nodes;
	}
}

function openHtmlTextInNewTab() {
	var newWin = open('url', '_blank', '');
	newWin.document.write($("#htmlText").val());
	newWin.document.title = document.title;
}



</script>
<style type="text/css">

.itemImage {
	padding : 10px;
}

.ui-widget {
	/* Reduces JQUery's default font size */
    font-size: 90%;
}

body {
        background-color : #E7EDE1;
}

.ui-tabs .ui-tabs-panel {
	background-color : #E7EDE1;
}

circle.node {
  cursor: pointer;
  stroke: #000;
  stroke-width: .5px;
}

line.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}

.truncate{
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    max-width: 400px;
    max-height: 51px;
    text-align: left;
}

//.urlTable.tbody.tr.td {
    text-align: left;
//}
</style>
<style>
.ui-effects-transfer { border: 2px dotted gray; }

body{
	font-family:Verdana; font-size: 12px;
	//text-shadow:4px 4px #eeeeee;
}

.genericButton {
	background-color: #FDFD96;
	border-radius: 28px;
}
.genericButton:hover {
	border-radius: 1px;
}

.tooBig {
	width: 200px; 
	height: 100px; 
	overflow-y: scroll;
}

.buttonize {
	//padding:20px;
	margin:25px;
	border-radius: 15px;
	box-shadow:
		inset 0 0 9px #222222, 
		10px 10px 14px #999999;// internal and external shadow
	background-color:#E6FAD2
}

.screenshot {
	padding:0px;
	margin:0px;
	border-radius: 15px;
	box-shadow:
		inset 0 0 9px #222222, 
		0px 0px 0px #999999;// internal and external shadow
	/* background-color:#E6FAD2*/
}
</style>

<script language="javascript" type="text/javascript" src="http://philogb.github.io/jit/static/v20/Jit//jit-yc.js"></script>
<link type="text/css" href="http://philogb.github.io/jit/static/v20/Jit/Examples/css/base.css" rel="stylesheet" />

</head>
<body onload='initialize()' style="background-color : #E7EDE1;">

<br>
<script> 
    $(function(){
      $("#menubar").load("http://netgear.rohidekar.com/menu.html"); 
    });
</script>
<div id="menubar"></div>

	<br>
	<table>
		<tr><td>
			<div id="queue"></div>
		</td><td>
			<table style="width: 100%;table-layout: fixed;">
				<tr>
					<td width="25%" valign=top>

						<a id="up">Up</a>
						<a href="http://netgear.rohidekar.com:44442/yurl/dumpurls">Export</a>
						<!--
						<strike><a href="http://netgear.rohidekar.com/launcher">Netcat Query</a></strike>
						-->
						<div id=rootColor class="buttonize">
							<center>
								<br><h2><span id="category"></span>(<span id="count"></span>)<br></h2><br>
							</center>
						</div>

						<!--Favorites-->
						<div id='favorites' class='buttonize'>
							<a href='/yurl/?rootId=29196' >Products & Services</a><br>
							<a href='/yurl/?rootId=221013'>Buy these (or considering buying)</a><br>
							<a href='/yurl/?rootId=230184'>Bought</a><br>
							<a href='/yurl/?rootId=37373'> Owned</a><br>
							<a href='/yurl/?rootId=608592'>Library</a><br><br>
							<a href='/yurl/?rootId=610307'>Audiobooks of interest</a><br>
							<a href='/yurl/?rootId=609457'>DVDs</a><br>
							<a href='/yurl/?rootId=624185'>DVDs/Soccer</a><br>
							<a href='/yurl/?rootId=621314'>DVDs/Wrestling</a><br>
							<a href='/yurl/?rootId=37906'>DVDs/Wrestling/DVDs</a><br>
							<a href='/yurl/?rootId=609458'>Amazon Instant Video</a><br><br>

							

							<a href='/yurl/?rootId=469990' >Home (Photos)</a><br>
							<a href='/yurl/?rootId=999999999'>Food</a><br>'
							<a href='/yurl/?rootId=37658' >Youtube Playlists (videos)</a><br>
							<a href='/yurl/?rootId=37567'>Watch these</a><br>
							<a href='/yurl/?rootId=37652'>Watched</a><br>
							<a href='/yurl/?rootId=322647'>Atletico Madrid Documentary</a><br><br>

							<a href='/yurl/?rootId=221026'> Download</a><br>
							<a href='/yurl/?rootId=37581'> Download these</a><br>
							<a href='/yurl/?rootId=322410'> Downloaded</a><br><br>

							<a href='/yurl/?rootId=38907'>Priority 3</a><br>
							<a href='/yurl/?rootId=29172'>Other</a><br>
							<a href='/yurl/?rootId=641426'>Autism / Aspergers</a><br>
						</div>

						<ol id="keyLinks"  class="buttonize" style="" ></ol>
						<font color=grey><div id="status">Init</div></font>
						<textarea id="keys" cols="34" rows="20px" class="buttonize"></textarea>
						<!-- I don't see a good reason to have both keys and categoriesTree. Hopefully JSON Tree
							will replace both -->
						<br>Tree of Categories / Category tags<br>
						<div id="categoriesRecursive"  class="buttonize tooBig">
						<!--<div id="categoriesTree" class="buttonize tooBig" ></div>-->
						<br><br>

						<br><br>
						</div>
						
					</td>
					
					<td width="75%" style="vertical-align: top">

<!--



* a smart TV view


yurl export ideas

tv channel (m3u)
rough cut (m3u)
page rss feed (xml)
scrolling text (html)
syllabus (pdf)
create your own re-podcast feed (.xml)
playlists
to watch list
compilation of videos (e.g. world cup highlights)
listen list
shopping list (pdf)
library visit list
owned items (thumbnails)
podcast subscriptions & favorite episodes
watch history (video library) - thumbnail index
reading list (pdf))


//* thumbnails
//** to identify and open what you're looking for most (e.g. videos)
//* cards
//** sorting into subcategory
//* table view
//** deciding whether to buy a product before others you already want
//** as compact as Google Reader/Feedly (so you don't feel like creating RSS feeds so that you can view in Feedly)
//* plaintext
//** for future-proofing, platform independent portability
//** must contain urls and titles
//* pdf (compact)
//** for a simple list to take when travelling to a bookstore
//** doesn't need to have URLs
//* pdf (argos catalog view)
//** printed summary for browsing in bedroom when bookshelf isn't big enough
//** for seeing what you own
//** for seeing what you could buy when you're passively shopping

-->
Yurl: Curates the web
<br>
TODO:<br>
** create a manual videos page based on yurl video category (read-only)<br>
** Don't print such ugly timestamps<br>
<!--** yurl_httpcat.txt - create a file yurl_httpcat_category_paths.txt<br>
*** yurl_categories.txt - ID, category_path<br>
*** yurl_exhaustive.txt - combine yurl_httpcat.txt and ~/github/yurl/export_all.txt<br>
** Later - /Yurl_json/<br>
-->
<!--
<strike>* Get off Neo4j completely. Upgrading Ubuntu or JDK causes issues, and it's easy to corrupt the database.</strike><br>
<strike>** /Yurl_plaintext/</strike><br>
<strike>* Don't print such ugly timestamps</strike><br>
-->
<br>
						<div id="tabs">
							  <a href="http://netgear.rohidekar.com/yurl/?rootId=221013&limit=500" id="url">http://netgear.rohidekar.com/yurl/?rootId=221013&limit=500</a>
							  <ul>
								<li><a href="#tabs-1">Grid/Thumbnails</a></li>
								<li><a href="#tabs-2">Cards</a></li>
								<li><a href="#tabs-3">Table</a></li>
								<li><a href="#tabs-4">Printable/PDF (compact)</a></li>
								<li><a href="#tabs-5">Plaintext/Export</a></li>
								<li><a href="#tabs-6">List</a></li>
								<li><a href="#tabs-7">Catalog</a></li>
								<li><a href="#tabs-8">Products</a></li>
								<li><a href="#tabs-9">HTML</a></li>
								<li><a href="#tabs-10">Image URLs</a></li>
								<li><a href="#tabs-11">URLs <img src="notepad_file-0.png" height=20px></a></li>
							  </ul>
							  <div id="tabs-1">
									To identify and open what you're looking for most (e.g. videos)<br>
									Video storyboarding
									Before buying, remember that it is better to want than own.
									HCat does not refresh the cache, you need to delete manually (so if new data is not appearing, that's why)
								  <ol id="url_thumbnails"></ol>
								  
							  </div>
							  <div id="tabs-2">
									TODO: downloaded videos button color rendering slows down loading, do it asynchronously (also the successfully downloaded videos file contains a lot of wrong information)
								  <br>
  									For sorting into subcategories 
								  <ol id="url_cards"></ol>
							  </div>
							  <div id="tabs-3">
									  Use cases:<br>
									* Deciding whether to buy a product before others you already want<br>
									* As compact as Google Reader/Feedly (so you don't feel like creating RSS feeds so that you can view in Feedly)<br>
								  <ol id="url_table"></ol>
									
							  </div>
							  <div id="tabs-4">
									 Use cases:<br>
									* for a simple list to take when travelling to a bookstore<br>
									* doesn't need to have URLs<br>
								  <ol id="printable"></ol>
									 
							  </div>
							  <div id="tabs-5">
									Use Cases:<br>
									* for future-proofing, platform independent portability<br>
									* must contain urls and titles<br>

								  <ol id="plaintext"></ol>
							  </div>
							  <div id="tabs-6">
									  Use cases:<br>
									* Sharing large lists on a forum<br>
									* Sharing a list in email (though email with rich media can do better)
								  <ol id="list"></ol>
							</div>
							<div id="tabs-7">
									* printed summary for browsing in bedroom when bookshelf isn't big enough (so it must be more compact than the web view for thumbnails of products; if anything, the thumbnails for the web view are too big)<br>
									* for seeing what you own<br>
									* for seeing what you could buy when you're passively shopping<br>
							  </div>
							<div id="tabs-8">
							  <ol id="products"></ol>
							</div>
							<div id="tabs-9">
							  <a href="" onclick="openHtmlTextInNewTab()">Open in new tab</a><br>
							  <br>
							  <textarea id="htmlText" rows=20 cols=100 style="white-space: nowrap; overflow: none;"></textarea>
							</div>
							<div id="tabs-10">
							 Use cases:<br>
							 * Heap<br>
							  <br>
							  <textarea id="imageUrls" rows=20 cols=100 style="white-space: nowrap; overflow: none;"></textarea>
							</div>
							<div id="tabs-11">
                                                          <textarea id="urls" rows=20 cols=100 style="white-space: nowrap; overflow: none;"></textarea>
							</div>
						</div>
<!--						<button type=button onclick='$("#d3").toggle()'>Show visualization</button>
						<div id="d3" style="background-color:grey"></div>
						
						<input type="button" value="Add URLs" onclick="sendBatch()" /><br>
						<div id="batchStatus"></div>
						<textarea id="urlBatchToSend" rows="20" cols="100"></textarea>
						-->
					</td>
				</tr>
				<tr>
					<td></td>
					<td>
					</td>
				</td>
			</table>	
		</td></tr>
	<table>
<br>

<button type=button onclick='$("#d3").toggle()'>Show visualization</button>
<div id="d3" style="background-color:grey"></div>
<!--<div id="infovis" style="background-color : black"></div>    -->

<input type="button" value="Add URLs" onclick="sendBatch()" /><br>
<div id="batchStatus"></div>
<textarea id="urlBatchToSend" rows="20" cols="100"></textarea>

<textarea cols=200>
javascript:window.location.href = 'http://netgear.rohidekar.com/yurl/stash2.html?url=' + encodeURIComponent(document.URL) + '&nodeId=45'  ;
/* main: 45, product: 29196, video: 37658, tech: 46, other: 29172 */
</textarea>
<br>
<br>
<br>
</body>
</html>
